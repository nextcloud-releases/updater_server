name: Upgrades

on:
  pull_request:
  push:
    branches:
      - master

concurrency: 
  group: upgrades-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest

    outputs:
      config: ${{ steps.changes.outputs.config }}

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # If the config has not changed, we skip
      # It allows us to still have a summary result
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          filters: |
            config:
              - 'config/config.php'
              - '.github/workflows/upgrade.yml'

  configs:
    if: needs.changes.outputs.config == 'true'
    runs-on: ubuntu-latest
    needs: changes

    outputs:
      configs: ${{ steps.build-config.outputs.configs }}

    name: Initializing ${{matrix.channel}} configs
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Getting config
        id: get-config
        run: |
          # Retrieving non-EOL configs from the matrix channel
          CONFIGS=$(php -r "echo(json_encode(include 'config/config.php'));" | jq -c)
          echo "::set-output name=configs::$CONFIGS"

      - name: Parse configs
        uses: nextcloud/updater_server@action
        id: build-config
        with:
          # Edit the following line to install packages required to run your script.
          configs: ${{ steps.get-config.outputs.configs }}

  upgrades:
    runs-on: ubuntu-latest
    needs: configs

    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJSON(needs.configs.outputs.configs) }}
        mode: ["updater", "manual"]

    name: Upgrade from ${{ matrix.config.base }} to ${{ matrix.config.latest }} (${{ matrix.config.channel }} - ${{ matrix.mode }})
    steps:
      - name: Set up php ${{ matrix.config.minPHPVersion }}
        uses: shivammathur/setup-php@ec406be512d7077f68eed36e63f4d91bc006edc4 # v2.35.4
        with:
          php-version: ${{ matrix.config.minPHPVersion }}
          extensions: ctype,curl,dom,fileinfo,gd,iconv,intl,json,mbstring,openssl,pdo_sqlite,posix,sqlite,xml,zip
          coverage: none

      - name: Fetch release
        run: |
          BASE="${{ matrix.config.base }}"
          
          # Normalize BASE to full MAJOR.MINOR.PATCH format
          if [[ "$BASE" =~ ^[0-9]+$ ]]; then
            BASE="${BASE}.0.0"
          elif [[ "$BASE" =~ ^[0-9]+\.[0-9]+$ ]]; then
            BASE="${BASE}.0"
          fi

          echo "Normalized base version: $BASE"

          # Try fetching official releases first, then prereleases (rc1–rc5), then fallback to latest-major
          wget --quiet "https://download.nextcloud.com/server/releases/nextcloud-${BASE}.zip" -O nextcloud-base.zip \
            || wget --quiet "https://download.nextcloud.com/server/prereleases/nextcloud-${BASE}.zip" -O nextcloud-base.zip \
            || for rc in {1..5}; do
                wget --quiet "https://download.nextcloud.com/server/prereleases/nextcloud-${BASE}rc${rc}.zip" -O nextcloud-base.zip && break
              done \
            || wget --quiet "https://download.nextcloud.com/server/releases/latest-${BASE%%.*}.zip" -O nextcloud-base.zip \
            || for beta in {1..6}; do
                wget --quiet "https://download.nextcloud.com/server/prereleases/nextcloud-${BASE}beta${beta}.zip" -O nextcloud-base.zip && break
              done

          unzip -q nextcloud-base.zip
          VERSION=$(php nextcloud/occ --output=json status | jq -r .version)
          VERSION_STRING=$(php nextcloud/occ --output=json status | jq -r .versionstring)
          echo "Fetched version: $VERSION"
          echo "BASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "BASE_VERSION_STRING=$VERSION_STRING" >> $GITHUB_ENV

      - name: Setup nextcloud ${{ env.BASE_VERSION_STRING }} (${{ env.BASE_VERSION }})
        run: |
          cd nextcloud
          mkdir data
          php occ maintenance:install --verbose --admin-user admin --admin-pass admin

      - name: Fetch upgrade
        if: matrix.mode == 'manual'
        run: |
          mv nextcloud nextcloud.old
          wget --quiet ${{ matrix.config.downloadUrl }} -O nextcloud-update.zip
          unzip -q nextcloud-update.zip
          VERSION=$(php nextcloud/occ --output=json status | jq -r .version)
          VERSION_STRING=$(php nextcloud/occ --output=json status | jq -r .versionstring)
          echo "Fetched version: $VERSION"
          echo "TARGET_VERSION=$VERSION" >> $GITHUB_ENV
          echo "TARGET_VERSION_STRING=$VERSION_STRING" >> $GITHUB_ENV

      - name: Copy necessary files
        if: matrix.mode == 'manual'
        run: |
          mv nextcloud.old/config/config.php nextcloud/config/config.php
          mv nextcloud.old/data nextcloud/data

      - name: Perform upgrade to ${{ env.TARGET_VERSION_STRING }} (${{ env.TARGET_VERSION }})
        if: matrix.mode == 'manual'
        run: |
          cd nextcloud
          php occ upgrade -v

      - name: Use updater
        if: matrix.mode == 'updater'
        run: |
          cd nextcloud
          BASE="${{ matrix.config.base }}"
          MAJOR="${BASE%%.*}"

          URL="https://raw.githubusercontent.com/nextcloud/updater/stable$MAJOR/updater.phar"
          FALLBACK="https://raw.githubusercontent.com/nextcloud/updater/master/updater.phar"

          echo "Downloading updater from $URL ..."
          if ! curl --fail --silent --show-error --location "$URL" -o updater/updater.phar; then
            echo "Stable$MAJOR not found, falling back to master ..."
            curl --fail --silent --show-error --location "$FALLBACK" -o updater/updater.phar
          fi
          php updater/updater.phar --url ${{ matrix.config.downloadUrl }} --no-backup --no-interaction -vvv

      - name: Integrity check
        run: |
          cd nextcloud
          php occ integrity:check-core

      - name: Verify final Nextcloud version
        run: |
          cd nextcloud
          VERSION=$(php occ --output=json status | jq -r .version)
          VERSION_STRING=$(php occ --output=json status | jq -r .versionstring)
          echo "Detected version: $VERSION"
          # Get the prefix from the matrix config and only take the part before the first space
          # This is for enterprise compatibility
          PREFIX="${{ matrix.config.latest }}"
          PREFIX="${PREFIX%% *}"  # remove everything after the first space
          echo "Expected prefix: $PREFIX"
          if [[ "$VERSION" != "$PREFIX"* ]]; then
            echo "❌ Version check failed: $VERSION does not start with $PREFIX"
            exit 1
          fi
          echo "✅ Version check passed"

          echo "Fetched version: $VERSION"
          echo "TARGET_VERSION=$VERSION" >> $GITHUB_ENV
          echo "TARGET_VERSION_STRING=$VERSION_STRING" >> $GITHUB_ENV

      - name: Successfully upgraded from ${{ env.BASE_VERSION_STRING }} to ${{ env.TARGET_VERSION_STRING }}
        if: success()
        run: echo "🎉 Upgrade successful!"

      - name: Cat logs on failure
        if: failure()
        run: |
          cd nextcloud
          cat data/*.log

  summary:
    runs-on: ubuntu-latest
    needs: [changes, upgrades]

    if: always()

    name: upgrades-summary

    steps:
      - name: Summary status
        run: if ${{ needs.changes.result == 'success' && needs.upgrades.result != 'success' && needs.upgrades.result != 'skipped' }}; then exit 1; fi
